networks:
  ridehub-network:
    driver: bridge

services:
  kafka:
    image: quay.io/strimzi/kafka:0.48.0-kafka-4.1.0
    container_name: kafka
    hostname: kafka
    restart: unless-stopped
    user: root
    command:
      - /bin/bash
      - -c
      - |
        # Set log directory to writable location
        export LOG_DIR=/tmp/kafka-logs
        mkdir -p $$LOG_DIR
        # Format KRaft storage (only if not already formatted)
        export CLUSTER_ID=$${CLUSTER_ID:-kafka-cluster-01}
        if [ ! -f /var/lib/kafka/data/meta.properties ]; then
          bin/kafka-storage.sh format -t $$CLUSTER_ID -c /tmp/kraft-config.properties
        fi
        # Start Kafka
        bin/kafka-server-start.sh /tmp/kraft-config.properties
    ports:
      - "9094:9092" # External SSL (moved from 9092)
      - "9093:9093" # OAuth SASL_SSL
    environment:
      # Cluster ID for KRaft
      CLUSTER_ID: kafka-cluster-01
      # Disable GC logging to avoid permission issues
      KAFKA_GC_LOG_OPTS: " "
      # Kafka logging for OAuth
      KAFKA_LOG4J_LOGGERS: "io.strimzi.kafka.oauth=DEBUG,org.apache.kafka.common.security.oauthbearer=DEBUG"
      # SSL passwords
      APP_F4_PASS: ${APP_F4_PASS}
      # Vault integration
      VAULT_ADDR: http://vault:8200
      VAULT_TOKEN: root
      SPRING_CLOUD_VAULT_URI: http://vault:8200
      SPRING_CLOUD_VAULT_TOKEN: root
    volumes:
      # Mount KRaft configuration file
      - ./central-server-config/kafka-config/kraft-config.properties:/tmp/kraft-config.properties:ro
      # SSL certificates (used for all listeners)
      - ./central-server-config/tls/kafka.broker.keystore.jks:/etc/kafka/secrets/kafka.broker.keystore.jks:ro
      - ./central-server-config/tls/kafka.client.truststore.jks:/etc/kafka/secrets/kafka.client.truststore.jks:ro
      # CA certificates for remote Keycloak
      - /etc/ssl/certs:/etc/ssl/certs:ro
      # Persistent data
      - kafka-oauth-data:/var/lib/kafka/data
    depends_on:
      vault:
        condition: service_started
      keycloak:
        condition: service_healthy
    labels:
      autoheal: "true"
    healthcheck:
      test: [ "CMD-SHELL", "nc -z localhost 9093 || exit 1" ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s

  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafka-ui
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS=kafka:19092
      - JVM_OPTS=-Xms256M -Xmx512M
      - APP_F4_PASS=${APP_F4_PASS}
    volumes:
      - ./central-server-config/tls:/etc/kafka/secrets:ro
    depends_on:
      kafka:
        condition: service_healthy
    labels:
      autoheal: "true"
    healthcheck:
      test: [ "CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health | grep -q 'UP'" ]
      interval: 15s
      timeout: 5s
      retries: 10
      start_period: 20s

  consul:
    image: hashicorp/consul:1.21.0
    restart: unless-stopped
    ports:
      - 8300:8300
      - 8500:8500
      - 8600:8600
    command: consul agent -dev -ui -client 0.0.0.0 -log-level=INFO
    labels:
      autoheal: "true"
    healthcheck:
      test: [ "CMD-SHELL", "curl -sf http://localhost:8500/v1/status/leader | grep -q :8300" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  consul-config-loader:
    image: jhipster/consul-config-loader:v0.4.1
    restart: unless-stopped
    volumes:
      - ./central-server-config:/config
    environment:
      - INIT_SLEEP_SECONDS=5
      - CONSUL_URL=consul
      - CONSUL_PORT=8500
    depends_on:
      consul:
        condition: service_healthy
    labels:
      autoheal: "true"

  redis:
    image: redis:7.4.2
    restart: unless-stopped
    ports:
      - "6379:6379"
    command: redis-server --requirepass ${APP_F4_PASS}
    labels:
      autoheal: "true"
    healthcheck:
      test: [ "CMD-SHELL", "redis-cli -a \"$APP_F4_PASS\" ping | grep -q PONG" ]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 10s

  redisinsight:
    image: redis/redisinsight:latest
    container_name: redisinsight
    restart: unless-stopped
    environment:
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${APP_F4_PASS}
    depends_on:
      redis:
        condition: service_healthy
    labels:
      autoheal: "true"

  keycloak:
    image: quay.io/keycloak/keycloak:26.1.1
    restart: unless-stopped
    command:
      - "start-dev"
      - "--import-realm"
      - "--proxy=edge"
      - "--hostname=https://keycloak.${DOMAIN}"
      - "--hostname-admin=https://keycloak.${DOMAIN}"
      - "--hostname-strict=true"
    volumes:
      - ./central-server-config/realm-config:/opt/keycloak/data/import
      - ./central-server-config/realm-config/keycloak-health-check.sh:/opt/keycloak/health-check.sh
      # - ./keycloak-custom-reg/lib:/opt/keycloak/providers
    environment:
      - KC_DB=dev-file
      - KEYCLOAK_ADMIN=${KEYCLOAK_ADMIN}
      - KEYCLOAK_ADMIN_PASSWORD=${KEYCLOAK_ADMIN_PASSWORD}
      - KC_FEATURES=scripts
      - KC_HTTP_PORT=9080
      - KC_HTTPS_PORT=9443
      - KC_HEALTH_ENABLED=true
      - KC_HTTP_MANAGEMENT_PORT=9990
      - KC_HOSTNAME_PORT=443
      - KC_FRONTEND_URL=https://keycloak.${DOMAIN}
      - KC_HOSTNAME_STRICT_HTTPS=true
      - KC_HTTP_ENABLED=true
    healthcheck:
      test: 'bash /opt/keycloak/health-check.sh'
      interval: 5s
      timeout: 5s
      retries: 50
      start_period: 10s
    labels:
      autoheal: "true"

  nginx:
    build: ./nginx/
    container_name: nginx
    restart: unless-stopped
    # depends_on:
    #   keycloak:
    #     condition: service_healthy
    ports:
      - "80:80"
      - "443:443"
    environment:
      - DOMAIN=${DOMAIN}
      - OIDC_CLIENT_SECRET=${OIDC_CLIENT_SECRET}
      - OIDC_CLIENT_ID=${OIDC_CLIENT_ID}
      - CONSUL_HTTP_TOKEN=${APP_F4_PASS}
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d
      - ./nginx/letsencrypt:/etc/letsencrypt
      - ./nginx/www:/var/www/html
      - ./nginx/log:/var/log/nginx
      - ./lua/validate_token.lua:/etc/nginx/validate_token.lua
      - ./lua:/etc/nginx/lua
      - ./central-server-config/nginx-init.sh:/etc/nginx/nginx-init.sh:ro
      - ./lua:/etc/nginx/lua
      - ./central-server-config/default.conf.template:/etc/nginx/templates/default.conf.template:ro
    command: [ "/bin/sh", "/etc/nginx/nginx-init.sh" ]
    extra_hosts:
      - "host.docker.internal:host-gateway"

  vault:
    image: hashicorp/vault:latest
    container_name: vault
    restart: unless-stopped
    ports:
      - "8200:8200"
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: ${APP_F4_PASS}
      VAULT_ADDR: http://0.0.0.0:8200
    volumes:
      - ./central-server-config:/central-server-config:ro
      - ./.env:/vault-secrets.env:ro
      - ./vault/vault-startup.sh:/vault-startup.sh:ro
    command: [ "/bin/sh", "/vault-startup.sh" ]
  loki:
    image: grafana/loki:3.1.1
    container_name: loki
    restart: unless-stopped
    ports:
      - "3100:3100"

  promtail:
    image: grafana/promtail:3.1.1
    container_name: promtail
    restart: unless-stopped
    user: "0" # chạy bằng root để đọc được docker.sock
    command: -config.file=/etc/promtail/promtail-config.yaml
    volumes:
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/run/docker.sock:/var/run/docker.sock
      - ./observability/promtail-config.yaml:/etc/promtail/promtail-config.yaml:ro
    depends_on:
      - loki

  grafana:
    image: grafana/grafana:11.2.0
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_ADMIN_USER}
      - GF_SECURITY_ADMIN_PASSWORD=${APP_F4_PASS}
    volumes:
      - grafana_data:/var/lib/grafana
    depends_on:
      - loki
  autoheal:
    image: willfarrell/autoheal:latest
    container_name: autoheal
    restart: unless-stopped
    environment:
      - AUTOHEAL_INTERVAL=5
      - AUTOHEAL_START_PERIOD=0
      - AUTOHEAL_DEFAULT_STOP_TIMEOUT=10
      # Only heal containers with label autoheal=true (default behavior)
      # - AUTOHEAL_CONTAINER_LABEL=autoheal
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
  # sms-gateway:
  #   image: ghcr.io/android-sms-gateway/server:latest
  #   container_name: sms-gateway
  #   ports:
  #     - "3002:3000"
  #   volumes:
  #     - ./sms-config/configsms.yml:/app/config.yml
  #   restart: unless-stopped
  #   depends_on:
  #     sms-mysql:
  #       condition: service_started
  # sms-mysql:
  #   image: mysql:9.2.0
  #   volumes:
  #     - ./config/mysql:/etc/mysql/conf.d
  #   ports:
  #     - "3306:3306"
  #   environment:
  #     MYSQL_DATABASE: sms
  #     MYSQL_ROOT_PASSWORD: rootpassword
  #     MYSQL_USER: smsuser
  #     MYSQL_PASSWORD: smspassword
  # elasticsearch:
  #   image: docker.elastic.co/elasticsearch/elasticsearch:8.13.4
  #   restart: unless-stopped
  #   environment:
  #     - ES_JAVA_OPTS=-Xms256m -Xmx256m
  #     - discovery.type=single-node
  #     - xpack.security.enabled=false
  #   ports:
  #     - 9200:9200
  #   healthcheck:
  #     test: [ "CMD", "curl", "-f", "http://localhost:9200/_cluster/health?wait_for_status=green&timeout=10s" ]
  #     interval: 10s
  #     timeout: 10s
  #     retries: 10

  # gkg:
  #   build:
  #     context: ./gkg
  #   container_name: gkg
  #   restart: unless-stopped
  #   volumes:
  #     - ../repositories:/repositories
  #     - ./gkg/data:/data/gkg
  #   expose:
  #     - "27496"
  #   healthcheck:
  #     test: [ "CMD-SHELL", "curl -fsS http://localhost:27495/ >/dev/null || exit 1" ]
  #     interval: 15s
  #     timeout: 5s
  #     retries: 20

volumes:
  vault_data:
  kafka-oauth-data:
    driver: local
  grafana_data:
